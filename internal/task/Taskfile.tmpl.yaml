---
# File generated by DataRobot CLI, regenrate using `dr task compose`
version: '3'
env:
  ENV: testing
dotenv: ['.env', '.env.{{ "{{" }}.ENV{{ "}}" }}']
includes:
  {{- range .Includes }}
  {{ .Name }}:
    taskfile: {{ .Taskfile }}
    dir: {{ .Dir }}
  {{- end }}
tasks:
  default:
    desc: "â„¹ï¸ Show all available tasks (run `task --list-all` to see hidden tasks)"
    cmds:
      - task --list --sort none
    silent: true
{{- if .HasStart }}

  start:
    desc: "ğŸ’» Prepare local development environment"
    cmds:
      - dr dotenv setup
      - task: install
      {{- range .StartComponents }}
      - task: {{ . }}:start
      {{- end }}
  {{- end }}
  {{- if .HasLint }}

  lint:
    desc: "ğŸ§¹ Run linters"
    cmds:
      {{- range .LintComponents }}
      - task: {{ . }}:lint
      {{- end }}
  {{- end }}

  {{- if .HasInstall }}

  install:
    desc: "ğŸ› ï¸ Install all dependencies"
    cmds:
      {{- range .InstallComponents }}
      - task: {{ . }}:install
      {{- end }}
  {{- end }}
  {{- if .HasTest }}

  test:
    desc: "ğŸ§ª Run tests across all components"
    cmds:
      {{- range .TestComponents }}
      - task: {{ . }}:test
      {{- end }}
  {{- end }}
  {{- if .HasDev }}
  dev:
    desc: "ğŸš€ Run all services together"
    cmds:
      - |
        {{- range $idx, $component := .DevComponents }}
        {{- if eq $idx 0 }}
        task {{ $component }}:dev &
        {{- else }}
        sleep 3
        task {{ $component }}:dev &
        {{- end }}
        {{- end }}
        sleep 8
        echo "âœ… All servers started!"
        if [[ -n "$NOTEBOOK_ID" ]]; then
          prefix="${DATAROBOT_API_ENDPOINT//api\/v2/}notebook-sessions/$NOTEBOOK_ID/ports/"
        else
          prefix="http://localhost:"
        fi
        {{- range .DevPorts }}
        echo "ğŸ”— {{ .Name }}: ${prefix}{{ .Port }}"
        {{- end }}
        wait
  {{- end }}

  {{- if .HasDeploy }}
  deploy:
    desc: "ğŸš€ Deploy all services"
    env:
      AGENT_DEPLOY: "1"
    cmds:
      {{- range .DeployComponents }}
      - task: {{ . }}:deploy
      {{- end }}
  {{- end }}

  {{- if .HasDeployDev }}
  deploy-dev:
    desc: "ğŸš€ Deploy infrastructure and services to development"
    cmds:
      {{- range .DeployDevComponents }}
      - task: {{ . }}:deploy-dev
      {{- end }}
  {{- end }}
