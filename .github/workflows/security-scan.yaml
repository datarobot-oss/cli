name: Security Scan

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  # schedule:
    # Run security scans weekly on Mondays at 9 AM UTC
    # - cron: '0 9 * * 1'

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    name: Trivy Vulnerability Scan
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'

# Skip this scan for now due to false positives and performance issues
  # gosec-scan:
  #   runs-on: ubuntu-latest
  #   name: GoSec Security Scan
  #   permissions:
  #     contents: read
  #     security-events: write
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4

  #     - name: Set up Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: '1.25.6'

  #     - name: Install gosec
  #       run: go install github.com/securego/gosec/v2/cmd/gosec@latest

  #     - name: Run gosec security scanner
  #       run: |
  #         gosec -fmt=sarif -out=gosec-results.sarif -exclude-dir=smoke_test_scripts ./... || true

  #     - name: Upload gosec results to GitHub Security tab
  #       uses: github/codeql-action/upload-sarif@v3
  #       if: always()
  #       continue-on-error: true
  #       with:
  #         sarif_file: 'gosec-results.sarif'

  #     - name: Run gosec security scanner (text output)
  #       run: |
  #         gosec -exclude-dir=smoke_test_scripts ./...

  # dependency-review:
  #   runs-on: ubuntu-latest
  #   name: Dependency Review
  #   # Only run on pull requests (not on push or schedule)
  #   if: github.event_name == 'pull_request'
  #   permissions:
  #     contents: read
  #     pull-requests: write
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4

  #     - name: Dependency Review
  #       uses: actions/dependency-review-action@v4
  #       with:
  #         fail-on-severity: moderate
  #         comment-summary-in-pr: on-failure

  # govulncheck:
  #   runs-on: ubuntu-latest
  #   name: Go Vulnerability Check
  #   permissions:
  #     contents: read
  #     security-events: write
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4

  #     - name: Set up Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: '1.25.6'

  #     - name: Install govulncheck
  #       run: go install golang.org/x/vuln/cmd/govulncheck@latest

  #     - name: Run govulncheck
  #       run: govulncheck ./...
