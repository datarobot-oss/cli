name: Daily Smoke Tests

concurrency:
  group: ${{ github.ref_name }}-smoke
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  schedule:
    # Run every 4 hours to avoid rate limits (6 times per day)
    - cron: '0 */4 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Binaries
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Build Windows Binary with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean --skip homebrew --skip archive

      - name: Build Linux/macOS Binary
        run: task build

      - name: Upload Linux/macOS Binary
        uses: actions/upload-artifact@v4
        with:
          name: dr-unix
          path: dist/dr
          retention-days: 1

      - name: Upload Windows Binary
        uses: actions/upload-artifact@v4
        with:
          name: dr-windows
          path: dist/windows_windows_amd64_v1/dr.exe
          retention-days: 1

  smoke-test:
    needs: build
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    name: Run Smoke Tests (${{ matrix.os }})
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: dr-unix
          path: /tmp/dr-bin

      - name: Move Binary to PATH
        run: |
          chmod +x /tmp/dr-bin/dr
          sudo mv /tmp/dr-bin/dr /usr/local/bin/dr

      - name: Ubuntu - Install expect w/ apt-get
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y expect

      - name: MacOS - Install expect w/ homebrew
        if: matrix.os == 'macos-latest'
        run: |
          brew install expect

      - name: Install yq
        uses: dcarbone/install-yq-action@v1.3.1

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Smoke Tests for Binary
        env:
          DR_API_TOKEN: ${{ secrets.DR_API_TOKEN }}
        run: |
          task smoke-test DR_API_TOKEN="$DR_API_TOKEN"

  windows-smoke-test:
    needs: build
    runs-on: windows-latest
    name: Run Smoke Tests (windows-latest)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Windows Binary
        uses: actions/download-artifact@v4
        with:
          name: dr-windows
          path: C:\temp\dr-bin

      - name: Move Binary to PATH
        shell: powershell
        run: |
          $INSTALL_DIR = "$env:LOCALAPPDATA\Programs\dr"
          New-Item -ItemType Directory -Force -Path "$INSTALL_DIR"
          Move-Item -Path "C:\temp\dr-bin\dr.exe" -Destination "$INSTALL_DIR\dr.exe" -Force
          echo "$INSTALL_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Smoke Tests for Binary
        run: |
          task smoke-test-windows

  installs-smoke-test:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    name: Installation Test (${{ matrix.os }})
    steps:
      - name: Install for Ubuntu and MacOS
        if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -fsSL https://cli.datarobot.com/install | sh

      - name: Install for windows
        if: ${{ matrix.os == 'windows-latest' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          irm https://cli.datarobot.com/winstall | iex

      - name: Check DR runs without errors (Ubuntu and MacOS)
        if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
        shell: bash
        run: |
          dr --help

      - name: Check DR runs without errors (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: powershell
        run: |
          C:\Users\runneradmin\AppData\Local\Programs\dr\dr.exe --help
