name: On-Demand Smoke Tests

on:
  pull_request:
    types: [labeled]

jobs:
  build-windows:
    if: |
      github.event.label.name == 'run-smoke-tests' ||
      github.event.label.name == 'go'
    runs-on: ubuntu-latest
    name: Build Windows Binary
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Build Windows Binary with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean --skip homebrew --skip archive

      - name: Upload Windows Binary
        uses: actions/upload-artifact@v4
        with:
          name: dr-windows
          path: dist/windows_windows_amd64_v1/dr.exe
          retention-days: 1

  notify-start:
    if: |
      github.event.label.name == 'run-smoke-tests' ||
      github.event.label.name == 'go'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Notify smoke tests starting
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'üöÄ Smoke tests triggered! Running on Linux and Windows...'
            });

  linux-smoke-tests:
    needs: notify-start
    runs-on: ubuntu-latest
    name: Linux Smoke Tests
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y expect bash-completion

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Build the DR CLI Binary
        run: task build

      - name: Move Binary to PATH
        run: sudo mv ./dist/dr /usr/local/bin/dr

      - name: Run Smoke Tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DR_API_TOKEN: ${{ secrets.DR_API_TOKEN }}
        run: |
          task smoke-test DR_API_TOKEN="$DR_API_TOKEN"

  windows-smoke-tests:
    needs: [build-windows, notify-start]
    runs-on: windows-latest
    name: Windows Smoke Tests
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Windows Binary
        uses: actions/download-artifact@v4
        with:
          name: dr-windows
          path: C:\temp\dr-bin

      - name: Move Binary to PATH
        shell: powershell
        run: |
          $INSTALL_DIR = "$env:LOCALAPPDATA\Programs\dr"
          New-Item -ItemType Directory -Force -Path "$INSTALL_DIR"
          Move-Item -Path "C:\temp\dr-bin\dr.exe" -Destination "$INSTALL_DIR\dr.exe" -Force
          echo "$INSTALL_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Smoke Tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DR_API_TOKEN: ${{ secrets.DR_API_TOKEN }}
        run: task smoke-test-windows

  notify-results:
    needs: [linux-smoke-tests, windows-smoke-tests]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const linuxStatus = '${{ needs.linux-smoke-tests.result }}';
            const windowsStatus = '${{ needs.windows-smoke-tests.result }}';

            const linuxEmoji = linuxStatus === 'success' ? '‚úÖ' : '‚ùå';
            const windowsEmoji = windowsStatus === 'success' ? '‚úÖ' : '‚ùå';

            const allPassed = linuxStatus === 'success' && windowsStatus === 'success';
            const overallEmoji = allPassed ? '‚úÖ' : '‚ùå';
            const overallMessage = allPassed ? 'All smoke tests passed!' : 'Some smoke tests failed.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${overallEmoji} **${overallMessage}**\n\n` +
                    `${linuxEmoji} Linux: ${linuxStatus}\n` +
                    `${windowsEmoji} Windows: ${windowsStatus}\n\n` +
                    `[View run details](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });

      - name: Remove run-smoke-tests label
        uses: actions/github-script@v7
        with:
          script: |
            // Only remove run-smoke-tests label, keep 'go' label for categorization
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'run-smoke-tests'
              });
              console.log('Removed label: run-smoke-tests');
            } catch (error) {
              console.log('Label run-smoke-tests already removed or does not exist');
            }
