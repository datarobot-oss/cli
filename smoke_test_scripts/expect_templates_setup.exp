#!/usr/local/bin/expect -f

set timeout 60

# Use TERM=dumb to prevent terminal color probing which causes OSC sequences
set env(TERM) dumb

# Debug: Print the config path
puts "DATAROBOT_CLI_CONFIG: $env(DATAROBOT_CLI_CONFIG)"

spawn dr templates setup --config $env(DATAROBOT_CLI_CONFIG)

# Handle potential authentication prompt with longer timeout
set timeout 10
expect {
    "to connect your DataRobot credentials" {
        # Auth prompt appeared - this means token validation failed
        puts "\nERROR: Authentication required - token may be invalid or config not found"
        puts "Config path: $env(DATAROBOT_CLI_CONFIG)"
        exit 1
    }
    "more" {
        # Template list appeared - continue normally
        puts "Template list loaded successfully"
    }
    timeout {
        puts "ERROR: Timeout waiting for template list or auth prompt"
        exit 1
    }
}

set timeout -1

# Filter
send -- {/}

expect "Filter"
send -- "talk\n"

sleep 1
expect "Talk to My Docs"
send -- "\r\n"

sleep 1
expect "talk-to-my-docs-agents"
send -- "\r\n"

expect "Interactive Setup"
send -- "\r\n"

expect "PULUMI_CONFIG_PASSPHRASE"
send -- "\r\n"

expect "SESSION_SECRET_KEY"
send -- "TESTING_SESSION_SECRET_KEY\r\n"

expect "DATAROBOT_DEFAULT_EXECUTION_ENVIRONMENT"
send -- "\r\n"

expect "data source to use for this application"
send -- "\r\n"

expect "Environment Variables Menu"
send -- "\r\n"

# Component selection screen - press space to select first component, then enter
expect "Available Components"
sleep 1
send -- " "

sleep 1
send -- "\r\n"

expect eof
